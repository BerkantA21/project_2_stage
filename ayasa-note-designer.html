<!DOCTYPE html>
<html>
<head>
    <script src="https://unpkg.com/konva@9.2.0/konva.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvg/dist/browser/canvg.min.js"></script>
    <link rel="stylesheet" href="./style.css">
    <meta charset="utf-8"/>
    <title>
        Ayasa Note Designer
    </title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>

<div class="sidebar" style="left: 0px; z-index: 1; overflow: visible; top: 0px; width: 260px; bottom: 0px;">
    <h2>Cirkel:</h2>

    <div>Tekst: <input type="text" id="circleText"></div>
    <div>Kies cirkel kleur:<input type="color" role="colorSelect"></div>
    <div>Kies tekst kleur:<input type="color" role="colorSelect"></div>
    <div>
        <button class="create">Cirkel toevoegen</button>
    </div>

    <h2>Ovaal:</h2>
    <div>Tekst: <input type="text" id="ellipseText"></div>
    <div>Kies ovaal kleur:<input type="color" role="colorSelectEllipse"></div>
    <div>Kies tekst kleur:<input type="color" role="colorSelectEllipse"></div>
    <div>
        <button class="createEllipse">Ovaal toevoegen</button>
    </div>
    <div>
        <button class="delete">Verwijder</button>
    </div>
    <div>
        <button id="save">Opslaan als png</button>
    </div>
    <div>
        <button id="jsonButton">Opslaan als JSON</button>
    </div>
    <div>
        <label for="jsonFile">Importeer JSON</label>
        <input type="file" id="jsonFile"/>
    </div>
</div>

<div id="container"></div>
<script>//begin van de script
console.log('Welkom bij de Ayasa Note Designer!');
const width = window.innerWidth;
const height = window.innerHeight;

let circles = []; // globale array voor de cirkels
let ellipses = []; // globale array voor de ovalen
let selectedShapes = [];// globale array voor de geselecteerde vormen

const stage = new Konva.Stage({
    container: 'container',
    width: width,
    height: height,
});

//maak de layer aan
const attributeLayer = new Konva.Layer();

// de vierkant die de achtergrond van de cirkels en ovalen is
const square = new Konva.Rect({
    x: stage.width() / 2 - 650,
    y: stage.height() / 2 - 450,
    width: 1400,
    height: 900,
    draggable: false,
    fill: 'white',
    stroke: 'black',
    strokeWidth: 4,
});

//text van cirkel 1
const text1 = new Konva.Text({
    x: stage.width() / 2 - 350,
    y: stage.height() / 2 - 200 - 150, // position de tekst boven de cirkel
    text: 'Voorkant',
    fontSize: 30,
    fontFamily: 'Calibri',
    fill: 'black',
    align: 'center',
});
// maak cirkel 1
const circle = new Konva.Circle({
    x: stage.width() / 2 - 290, // move de cirkel naar links
    y: stage.height() / 2,
    radius: 230,
    draggable: false,
    fill: 'white',
    stroke: 'black',
    strokeWidth: 4,
    listening: false,
});

//text van cirkel 2
const text2 = new Konva.Text({
    x: stage.width() / 2 + 330,
    y: stage.height() / 2 - 200 - 150, // position de tekst boven de cirkel
    text: 'Achterkant',
    fontSize: 30,
    fontFamily: 'Calibri',
    fill: 'black',
    align: 'center',
});

// maak cirkel 2
const circle2 = new Konva.Circle({
    x: stage.width() / 2 + 400, // move de cirkel naar rechts
    y: stage.height() / 2,
    radius: 230,
    draggable: false,
    fill: 'white',
    stroke: 'black',
    strokeWidth: 4,
    listening: false,
});

// voeg de vormen toe aan de aatributelayer
attributeLayer.add(square);
attributeLayer.add(circle);
attributeLayer.add(circle2);
attributeLayer.add(text1);
attributeLayer.add(text2);
// Draw the layer
attributeLayer.draw();

// Add the attributeLayer to the stage
stage.add(attributeLayer);

let selectedTransformer = null;

//createCircle is een functie die een cirkel maakt
function createCircle(text, colors) {
    const colorObj = {
        background: colors[0],
        text: colors[1],
    }

    //const group is een groep die de cirkel en de tekst bevat.
    const group = new Konva.Group({
        draggable: true,
        name: 'objectGroup',
    });

    //const circle is de cirkel die in de groep zit.
    const circle = new Konva.Circle({
        x: stage.width() / 2 +50,
        y: stage.height() / 2,
        radius: 40,
        fill: colorObj.background,
        stroke: 'black',
        strokeWidth: 4,
    });

    //deze code maakt de text aan met de gegeven waardes in de cirkel
    const textNode = new Konva.Text({
        x: circle.x(),
        y: circle.y(),
        text: text,
        fontSize: 20,
        fontFamily: 'Calibri',
        fill: colorObj.text,
        align: 'center',
        offset: {
            x: text.length * 10 / 2,
            y: 20 / 2
        }
    });
    
        group.on('mouseup', (e) => console.log('mouseup event handler called'));

        group.add(circle);
        group.add(textNode);
        attributeLayer.add(group);
        attributeLayer.draw();
        circles.push(circle);

    // zorgt ervoor dat je de cirkel kan selecteren voor een multi select
     let isCircleSelected = false;
     group.on('mousedown', function (e) {
         if (e.evt.button === 0) {
             if (selectedTransformer) {
                 selectedTransformer.detach();
             }

            isCircleSelected = !isCircleSelected;
             circle.stroke(isCircleSelected ? 'blue' : 'black');

             attributeLayer.draw();
         }
     });

}
    
//deze functie zorgt ervoor dat je meerdere cirkels tegelijk kan verwijderen
function deleteSelectedCircles() {
    const selectedGroups = attributeLayer.getChildren(node => {
        if (node instanceof Konva.Group) {
            const circle = node.getChildren(c => c instanceof Konva.Circle)[0];
            return circle && circle.stroke() === 'blue';
        }
        return false;
    });
    // Loop door alle geselecteerde groepen heen
    selectedGroups.forEach(group => {
        //Deselcteer de cirkel
        const circle = group.getChildren(c => c instanceof Konva.Circle)[0];
        circle.stroke('black');

        // Verwijder de transformer van de cirkel
        const transformers = attributeLayer.find(node => node instanceof Konva.Transformer);
        transformers.forEach(transformer => {
            if (transformer.node() === circle) {
                transformer.detach();
            }
        });
        // verwijder de cirkel
        group.destroy();
    });

    attributeLayer.draw();
}

//deze eventlistener luistert naar een click event en voert de functie createCircle uit. colors is een array die de kleuren bevat en wordt verwezen naar de functie createCircle.
document.querySelector('.create').addEventListener('click', function () {
    const text = document.getElementById('circleText').value;

    const colors = Array.from(document.querySelectorAll('[role="colorSelect"]')).map((c) => c.value)
    const colorObj = {
        background: colors[0],
        text: colors[1],
    }
    createCircle(text, colors);
});

document.querySelector('.delete').addEventListener('click', function () {
    deleteSelectedCircles();
});

document.addEventListener('keydown', function(event) {
    if (event.key === 'Delete') {
        deleteSelectedCircles();
    }
})

function downloadURI(uri, filename) {
    var link = document.createElement('a');
    link.href = uri;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    delete link;
}

document.getElementById('save').addEventListener(
    'click',
    function () {
        var dataURL = stage.toDataURL({pixelRatio: 3});
        downloadURI(dataURL, 'stage.png');
    },
    false
);

//createEllipse is een functie die een ellipse maakt
function createEllipse(text, colors) {
    var colorObj = {
        background: colors[0],
        text: colors[1],
    }
    //const group is een groep die de ellipse en de tekst bevat.
    var group = new Konva.Group({
        draggable: true,
        name: 'objectGroup',
    });
    //const ellipse is de ellipse die in de groep zit.
    var ellipse = new Konva.Ellipse({
        x: stage.width() / 2 + 50,
        y: stage.height() / 2,
        radiusX: 80,
        radiusY: 30,
        fill: colorObj.background,
        stroke: 'black',
        strokeWidth: 4,
    });

    //deze code maakt de text aan met de gegeven waardes in de ellipse
    var textNode = new Konva.Text({
        x: ellipse.x(),
        y: ellipse.y(),
        text: text,
        fontSize: 20,
        fontFamily: 'Calibri',
        fill: colorObj.text,
        align: 'center',
        offset: {
            x: text.length * 10 / 2,
            y: 20 / 2
        }
    });

    group.add(ellipse);
    group.add(textNode);
    attributeLayer.add(group);
    attributeLayer.draw();
    ellipses.push(ellipse);

     let isEllipseSelected = false;
     group.on('mousedown', function (e) {
         if (e.evt.button === 0) {
             if (selectedTransformer) {
                 selectedTransformer.detach();
             }

             isEllipseSelected = !isEllipseSelected;
             ellipse.stroke(isEllipseSelected ? 'blue' : 'black');

             attributeLayer.draw();
         }
     });
}

// Maak een nieuwe laag
let layer = new Konva.Layer();

// Voeg de laag toe aan de stage
stage.add(layer);

// Maak een nieuwe groep
let group = new Konva.Group({
    draggable: true
});

// Voeg de groep toe aan de laag
layer.add(group);

// Maak de groep draggable
group.draggable(true);

// Teken de laag opnieuw om de wijzigingen te laten zien
layer.draw();

//deze functie zorgt ervoor dat je meerdere ellipses tegelijk kan verwijderen
function deleteSelectedEllipses() {
    const selectedGroups = attributeLayer.getChildren(node => {
        if (node instanceof Konva.Group) {
            const ellipse = node.getChildren(c => c instanceof Konva.Ellipse)[0];
            return ellipse && ellipse.stroke() === 'blue';
        }
        return false;
    });
    // Loop door alle geselecteerde groepen heen
    selectedGroups.forEach(group => {
        //Deselcteer de ellipse
        const ellipse = group.getChildren(c => c instanceof Konva.Ellipse)[0];
        ellipse.stroke('black');

        // Verwijder de transformer van de ellipse
        const transformers = attributeLayer.find(node => node instanceof Konva.Transformer);
        transformers.forEach(transformer => {
            if (transformer.node() === ellipse) {
                transformer.detach();
            }
        });
        // verwijder de ellipse
        group.destroy();
    });
    attributeLayer.draw(); // update de layer
}

//deze eventlistener luistert naar een click event en voert de functie createEllipse uit. colors is een array die de kleuren bevat en wordt verwezen naar de functie createEllipse.
document.querySelector('.createEllipse').addEventListener('click', function () {
    const text = document.getElementById('ellipseText').value;

    const colors = Array.from(document.querySelectorAll('[role="colorSelectEllipse"]')).map((c) => c.value)
    const colorObj = {
        background: colors[0],
        text: colors[1],
    }

    createEllipse(text, colors);
});

document.querySelector('.delete').addEventListener('click', deleteSelectedEllipses);

document.addEventListener('keydown', function(event) {
    if (event.key === 'Delete') {
        deleteSelectedEllipses();
    }
});

var transformer = new Konva.Transformer();
layer.add(transformer);

let selectionRectangle = new Konva.Rect({
    fill: 'rgba(0,0,255,0.5)',
    visible: false,
});
attributeLayer.add(selectionRectangle);

let x1, y1, x2, y2;
stage.on('mousedown', (e) => {
    if (e.target !== stage && e.target !== square) {
        return;
    }
    
    e.evt.preventDefault();

    x1 = stage.getPointerPosition().x;
    y1 = stage.getPointerPosition().y;
    x2 = stage.getPointerPosition().x;
    y2 = stage.getPointerPosition().y;

    selectionRectangle.visible(true);
    selectionRectangle.width(0);
    selectionRectangle.height(0);
});

stage.on('mousemove touchmove', (e) => {
    // do nothing if we didn't start selection
    if (!selectionRectangle.visible()) {
        return;
    }

    e.evt.preventDefault();

    x2 = stage.getPointerPosition().x;
    y2 = stage.getPointerPosition().y;

    selectionRectangle.setAttrs({
        x: Math.min(x1, x2),
        y: Math.min(y1, y2),
        width: Math.abs(x2 - x1),
        height: Math.abs(y2 - y1),
    });
});

stage.on('mouseup touchend', (e) => {
    if (! selectionRectangle.visible()) {
        return;
    }

    e.evt.preventDefault();
    
    setTimeout(() => selectionRectangle.visible(false));

    const shapes = stage.find('.objectGroup');
    const box = selectionRectangle.getClientRect();
    const selected = shapes.filter((shape) => Konva.Util.haveIntersection(box, shape.getClientRect()));

    transformer.nodes(selected);
});
// clicks should select/deselect shapes
stage.on('click tap', function (e) {
    // if we are selecting with rect, do nothing
    if (selectionRectangle.visible()) {
        return;
    }

    // if click on empty area - remove all selections
    if (e.target === stage) {
        tr.nodes([]);
        return;
    }

    // do nothing if clicked NOT on our rectangles
    if (!e.target.hasName('objectGroup') && !(e.target.getParent() && e.target.getParent().hasName('objectGroup'))) {
        return;
    }

    const metaPressed = e.evt.shiftKey || e.evt.ctrlKey || e.evt.metaKey;
    const node = e.target.getParent() && e.target.getParent().hasName('objectGroup') ? e.target.getParent() : e.target;
    const isSelected = transformer.nodes().indexOf(node) >= 0;

    if (!metaPressed && !isSelected) {
    
    transformer.nodes([node]);
} else if (metaPressed && isSelected) {
    
    const nodes = transformer.nodes().slice(); 
    
    nodes.splice(nodes.indexOf(node), 1);
    transformer.nodes(nodes);
} else if (metaPressed && !isSelected) {
    
    const nodes = transformer.nodes().concat([node]);
    transformer.nodes(nodes);
}
});

//begin json import en export
//importeer json
document.getElementById('jsonFile').addEventListener('change', function () {
    var file = this.files[0];
    var reader = new FileReader();
    reader.onload = function (e) {
        var contents = e.target.result;
        var json = JSON.parse(contents);
        stage = Konva.Node.create(json, 'container');
        stage.draw(); // Teken de stage opnieuw om de geïmporteerde vormen te tonen
    };
    reader.readAsText(file);
});
//exporteer json
document.getElementById('jsonButton').addEventListener('click', function () {
    var json = stage.toJSON();
    console.log(json);

    var blob = new Blob([json], {type: "application/json"});
    var url  = URL.createObjectURL(blob);

    var a = document.createElement('a');
    a.download = 'backup.json';
    a.href = url;
    a.click();
});
//einde json import en export
</script>
</body>
</html>
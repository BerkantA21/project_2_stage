<!DOCTYPE html>
<html>

<head>
    <script src="https://unpkg.com/konva@9.2.0/konva.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvg/dist/browser/canvg.min.js"></script>
    <meta charset="utf-8" />
    <title>
        KONVA SVG EDIT DEMO
    </title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #f0f0f0;
        }
    </style>
</head>

<body>
    <input type="text" id="circleText">
    Kies cirkel kleur:<input type="color" role="colorSelect">
    Kies tekst kleur:<input type="color" role="colorSelect">
    <button class="create">gen</button>
    <button class="delete">delete</button>

    <div id="container"></div>

    <script>//begin van de script
        
        const width = window.innerWidth;
        const height = window.innerHeight;

        const stage = new Konva.Stage({
            container: 'container',
            width: width,
            height: height,
        });

        const boundaryLayer = new Konva.Layer();
        stage.add(boundaryLayer);

        const SOURCE = '/x.svg';
        Konva.Image.fromURL(SOURCE, (imageNode) => {
            boundaryLayer.add(imageNode);
            imageNode.setAttrs({
                strokeWidth: 1,
                width: 600,
                height: 925,
            });
            boundaryLayer.draw();
        });

        
        // Define the attributeLayer first
        const attributeLayer = new Konva.Layer();

        
        
     // Create the square
    const square = new Konva.Rect({
        x: stage.width() / 2 - 450, 
        y: stage.height() / 2 - 450, 
        width: 900,
        height: 900,
        draggable: false,
        fill: 'white',
        stroke: 'black',
        strokeWidth: 4,
    });

    const circle = new Konva.Circle({
        x: stage.width() / 2,
        y: stage.height() / 2,
        radius: 300,
        draggable: false,
        fill: 'white',
        stroke: 'black',
        strokeWidth: 4,
    });

    // Add the shapes to the attributeLayer
    attributeLayer.add(square);
    attributeLayer.add(circle);

    // Draw the layer
    attributeLayer.draw();

        // Add the attributeLayer to the stage
        stage.add(attributeLayer);
        //createCircle is een functie die een cirkel maakt
        function createCircle(text, colors) {
            const colorObj = {
                background: colors[0],
                text: colors[1],
            }
            //const group is een groep die de cirkel en de tekst bevat.
            const group = new Konva.Group({
                draggable: true,
            });
            //const circle is de cirkel die in de groep zit.
            const circle = new Konva.Circle({
                x: stage.width() / 2,
                y: stage.height() / 2,
                radius: 70,
                fill: colorObj.background,
                stroke: 'black',
                strokeWidth: 4,
            });

            //deze code maakt de text aan met de gegeven waardes in de cirkel
            const textNode = new Konva.Text({
                x: circle.x(),
                y: circle.y(),
                text: text,
                fontSize: 20,
                fontFamily: 'Calibri',
                fill: colorObj.text,
                align: 'center',
                offset: {
                    x: text.length * 10 / 2, 
                    y: 20 / 2 
                }
            });

            group.add(circle);
            group.add(textNode);
            attributeLayer.add(group);
            attributeLayer.draw();

            group.on('dblclick', function () {
           
           if (isSelected) {
           isSelected = false;
           circle.stroke('black');
           transformer.detach();
           attributeLayer.draw();
   }
          group.destroy();
          attributeLayer.draw();
           });

           const transformer = new Konva.Transformer();
            attributeLayer.add(transformer);

            let isSelected = false;

               group.on('click', function () {
               isSelected = !isSelected;
               circle.stroke(isSelected ? 'blue' : 'black');

               if (isSelected) {
                   // Voeg de transformer toe aan de cirkel
                   transformer.attachTo(circle);
               } else {
                   // Verwijder de transformer van de cirkel
                   transformer.detach();
               }
               // update de layer.
               attributeLayer.draw();
           });
       }

               //deze functie zorgt ervoor dat je meerdere cirkels tegelijk kan verwijderen
        function deleteSelectedCircles() {
            const selectedGroups = attributeLayer.getChildren(node => {
                if (node instanceof Konva.Group) {
            const circle = node.getChildren(c => c instanceof Konva.Circle)[0];
                return circle && circle.stroke() === 'blue';
            }
                return false;
            });
    // Loop door alle geselecteerde groepen heen
        selectedGroups.forEach(group => {
    //Deselcteer de cirkel
        const circle = group.getChildren(c => c instanceof Konva.Circle)[0];
        circle.stroke('black');

        // Verwijder de transformer van de cirkel
        const transformers = attributeLayer.find(node => node instanceof Konva.Transformer);
        transformers.forEach(transformer => {
            if (transformer.node() === circle) {
                transformer.detach();
            }
        });

            // verwijder de cirkel
            group.destroy();
        });

            attributeLayer.draw();
        }

        //deze eventlistener luistert naar een click event en voert de functie createCircle uit. colors is een array die de kleuren bevat en wordt verwezen naar de functie createCircle.
        document.querySelector('.create').addEventListener('click', function () {
            const text = document.getElementById('circleText').value;
            
            const colors = Array.from(document.querySelectorAll('[role="colorSelect"]')).map((c) => c.value)
            const colorObj = {
                background: colors[0],
                text: colors[1],
            }

            console.log(colorObj);

            createCircle(text, colors);
        });

        document.querySelector('.delete').addEventListener('click', function () {
            deleteSelectedCircles();
        });
    </script>
</body>

</html>

<!DOCTYPE html>
<html>

<head> 
    <script src="https://unpkg.com/konva@9.2.0/konva.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvg/dist/browser/canvg.min.js"></script>
    <link rel="stylesheet" href="./style.css">
    <meta charset="utf-8" />
    <title>
        KONVA SVG EDIT DEMO
    </title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #f0f0f0;
        }
    </style>
</head>

<body>
    <div class="sidebar" style="left: 0px; z-index: 1; overflow: visible; top: -20px; width: 260px; bottom: 0px;">
        <h2>Cirkel:</h2>
        <div>Tekst: <input type="text" id="circleText"></div>
        <div>Kies cirkel kleur:<input type="color" id="backgroundColor"></div>
        <div>Kies tekst kleur:<input type="color" id="textColor"></div>
        <div><button class="createCircle">Cirkel knop</button></div>


        <h2>-----------------------------</h2>

        <h2>Ovaal:</h2>
        <div>Tekst: <input type="text" id="ellipseText"></div>
        <div>Kies ovaal kleur:<input type="color" id="EllipseBackgroundColor"></div>
        <div>Kies tekst kleur:<input type="color" id="EllipseTextColor"></div>
        <div><button class="createEllipse">Ovaal knop</button></div>

        <h2>-----------------------------</h2>

        <div><button class="delete">Verwijder</button></div>
        <div><button id="save">Opslaan als png</button></div>



        <div><input type="file" id="selectFiles" value="Import" /></div>
        <div><button id="import">Import</button></div>
        <div><button id="exportButton">Download JSON</button></div>
    </div>

    <div id="container"></div>
    <script>
        
        const width = window.innerWidth;
        const height = window.innerHeight;

        var stage = new Konva.Stage({
            container: 'container',
            width: width,
            height: height,
        });

        var layer = new Konva.Layer();
        stage.add(layer); 
        
            // Create the square (euer)
        var square = new Konva.Rect({
            x: stage.width() / 2 - 650,
            y: stage.height() / 2 - 450,
            width: 1400,
            height: 900,
            draggable: false,
            fill: 'white',
            stroke: 'black',
            strokeWidth: 4,
        });

        //text van cirkel 1
        var text1 = new Konva.Text({
            x: stage.width() / 2 - 350,
            y: stage.height() / 2 - 200 - 150, // position de tekst boven de cirkel
            text: 'Voorkant',
            fontSize: 30,
            fontFamily: 'Calibri',
            fill: 'black',
            align: 'center',
        });
        // Create the first circle
        var circle = new Konva.Circle({
            x: stage.width() / 2 - 290, // move de cirkel naar links
            y: stage.height() / 2,
            radius: 230,
            draggable: false,
            fill: 'white',
            stroke: 'black',
            strokeWidth: 4,
            listening: false,
        });

        //text van cirkel 2
        var text2 = new Konva.Text({
            x: stage.width() / 2 + 330,
            y: stage.height() / 2 - 200 - 150, // position de tekst boven de cirkel
            text: 'Achterkant',
            fontSize: 30,
            fontFamily: 'Calibri',
            fill: 'black',
            align: 'center',
        });

        // Create the second circle
        var circle2 = new Konva.Circle({
            x: stage.width() / 2 + 400, // move de cirkel naar rechts
            y: stage.height() / 2,
            radius: 230,
            draggable: false,
            fill: 'white',
            stroke: 'black',
            strokeWidth: 4,
            listening: false,
        });

        // voeg de vormen toe aan de aatributelayer
        layer.add(square);
        layer.add(circle);
        layer.add(circle2);
        layer.add(text1);
        layer.add(text2);
        // Draw the layer
        layer.draw();

        var tr = new Konva.Transformer();
        layer.add(tr);

        tr.nodes([]);

        // Add the layer to the stage
        stage.add(layer);
   
        function createCenterCircle(text, textColor, backgroundColor) {
            createCircle(text, textColor, backgroundColor, stage.width() / 2, stage.height() / 2);
        }

        //createCircle is een functie die een cirkel maakt
        // function createCircle(text, colors) {
        function createCircle(text, textColor, backgroundColor, x, y) {
            //const group is een groep die de cirkel en de tekst bevat.
            const group = new Konva.Group({
                draggable: true,
                exportable: true
            });

            //const circle is de cirkel die in de groep zit.
            const circle = new Konva.Circle({
                x: x,
                y: y,
                radius: 70,
                fill: backgroundColor,
                stroke: 'black',
                strokeWidth: 4,
                type: 'circle'
            });
            //deze code maakt de text aan met de gegeven waardes in de cirkel
            const textNode = new Konva.Text({
                x: circle.x(),
                y: circle.y(),
                text: text,
                fontSize: 20,
                fontFamily: 'Calibri',
                fill: textColor,
                align: 'center',
                offset: {
                    x: text.length * 10 / 2, 
                    y: 20 / 2 
                }
            });

            group.add(circle);
            group.add(textNode);
            layer.add(group);
            tr.nodes([group]);
            layer.draw();

           const transformer = new Konva.Transformer();
            layer.add(transformer);

            let isSelected = false;

               group.on('click', function () {
               isSelected = !isSelected;
               circle.stroke(isSelected ? 'blue' : 'black');

               if (isSelected) {
                   // Voeg de transformer toe aan de cirkel
                   transformer.attachTo(circle);
               } else {
                   // Verwijder de transformer van de cirkel
                   transformer.detach();
               }
               // update de layer.
               layer.draw();
           });
       }

        //  feature,selection rectangle
        var selectionRectangle = new Konva.Rect({
            fill: 'rgba(0,0,255,0.5)',
            visible: false,
        });
        layer.add(selectionRectangle);

        var x1, y1, x2, y2;
        stage.on('mousedown tochstart', (e) => {
            if (e.target !== stage) {
                return;
            }
            e.evt.preventDefault();
            x1 = stage.getPointerPosition().x;
            y1 = stage.getPointerPosition().y;
            x2 = stage.getPointerPosition().x;
            y2 = stage.getPointerPosition().y;

            selectionRectangle.visible(true);
            selectionRectangle.width(0);
            selectionRectangle.height(0);
        });

        stage.on('mousemove touchmove', (e) => {
            if (!selectionRectangle.visible()) {
                return;
            }
            e.evt.preventDefault();
            x2 = stage.getPointerPosition().x;
            y2 = stage.getPointerPosition().y;

            selectionRectangle.setAttrs({
                x:Math.min(x1, x2),
                y:Math.min(y1, y2),
                width: Math.abs(x2 - x1),
                height: Math.abs(y2- y1),
            });
        });


        stage.on('mouseup tochend', (e) => {
            if (!selectionRectangle.visible()) {
                return;
            }
            e.evt.preventDefault();
        // update visibility in timeout, so we can check it in click event
            setTimeout(() => {
            selectionRectangle.visible(false);
            });

            var shapes = stage.find('.rect');
            var box = selectionRectangle.getClientRect();
            var selected = shapes.filter((shape) =>
            Konva.Util.haveIntersection(box, shape.getClientRect())
            );
            tr.nodes(selected);
        });

        stage.on('click tap', function (e) {
            if (selectionRectangle.visible()) {
                return;
            }
            if (e.target === stage) {
                tr.nodes([]);
                layer.draw();
                return;
            }
            // do nothing if clicked NOT on our rectangles
        if (!e.target.hasName('rect')) {
          return;
        }

        // do we pressed shift or ctrl?
        const metaPressed = e.evt.shiftKey || e.evt.ctrlKey || e.evt.   metaKey;
        const isSelected = tr.nodes().indexOf(e.target) >= 0;

        if (!metaPressed && !isSelected) {
            // if no key pressed and the node is not selected
            // select just one
            tr.nodes([e.target]);
            } else if (metaPressed && isSelected) {
            // if we pressed keys and node was selected
            // we need to remove it from selection:
            const nodes = tr.nodes().slice(); // use slice to have new copy of array
            // remove node from array
            nodes.splice(nodes.indexOf(e.target), 1);
            tr.nodes(nodes);
            } else if (metaPressed && !isSelected) {
            // add the node into selection
            const nodes = tr.nodes().concat([e.target]);
            tr.nodes(nodes);
        }
      });
      //test code einde

               //deze functie zorgt ervoor dat je meerdere cirkels tegelijk kan verwijderen
        function deleteSelectedCircles() {
            const selectedGroups = layer.getChildren(node => {
                if (node instanceof Konva.Group) {
                    const circle = node.getChildren(c => c instanceof Konva.Circle)[0];
                    return circle && circle.stroke() === 'blue';
                }

                return false;
            });
            
            // Loop door alle geselecteerde groepen heen
            selectedGroups.forEach(group => {
                //Deselcteer de cirkel
                const circle = group.getChildren(c => c instanceof Konva.Circle)[0];
                circle.stroke('black');

                // Verwijder de transformer van de cirkel
                layer
                    .find(node => node instanceof Konva.Transformer)
                    .forEach(transformer => {
                        if (transformer.node() === circle) {
                            transformer.detach();
                        }
                    });

                // verwijder de cirkel
                group.destroy();
            });

            layer.draw();
        }



        /* ========== */
        // Circles
        /* ========== */

        const circleTextInput = document.getElementById('circleText');
        const circleBackgroundColorInput = document.getElementById('backgroundColor');
        const circleTextColorInput = document.getElementById('textColor');
        const createCircleButton = document.querySelector('.createCircle');

        const addCircleToField = () => {
            const text = circleTextInput.value;
            const backgroundColor = circleBackgroundColorInput.value;
            const textColor = circleTextColorInput.value;
            createCenterCircle(text, textColor, backgroundColor);
        };

        createCircleButton.addEventListener('click', addCircleToField);

        /* ========== */
        // Export knop
        /* ========== */

        const saveButton = document.getElementById('save');

        const savePng = () => {
            var dataURL = stage.toDataURL({ pixelRatio: 3 });
            downloadURI(dataURL, 'stage.png');
        };

        saveButton.addEventListener('click', savePng);

        document.querySelector('.delete').addEventListener('click', deleteSelectedCircles);

        function downloadURI(uri, filename) {
            var link = document.createElement('a');
            link.href = uri;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            delete link;
        }

        function createCenterEllipse(text, textColor, backgroundColor) {
            createEllipse(text, textColor, backgroundColor, x, y, radiusX, radiusY);
        }
      
        //createEllipse is een functie die een ellipse maakt
        function createEllipse(text, textColor, backgroundColor, x, y, radiusX, radiusY) {

            //const group is een groep die de ellipse en de tekst bevat.
            const group = new Konva.Group({
                draggable: true,
                exportable: true
            });
            
            //const ellipse is de ellipse die in de groep zit.
            const ellipse = new Konva.Ellipse({
                x: x,
                y: y,
                radiusX: 100,
                radiusY: 50,
                fill: backgroundColor,
                stroke: 'black',
                strokeWidth: 4,
                type: 'ellipse'
            });
            
            //deze code maakt de text aan met de gegeven waardes in de ellipse
            const textNode = new Konva.Text({
                x: ellipse.x(),
                y: ellipse.y(),
                text: text,
                fontSize: 20,
                fontFamily: 'Calibri',
                fill: textColor,
                align: 'center',
                offset: {
                    x: text.length * 10 / 2, 
                    y: 20 / 2 
                }
            });

            group.add(ellipse);
            group.add(textNode);
            layer.add(group);
            layer.draw();

            group.on('dblclick', function () {
           
           if (isSelected) {
           isSelected = false;
           ellipse.stroke('black');
           transformer.detach();
           layer.draw();
        }
            group.destroy();
            layer.draw();
           });

           const transformer = new Konva.Transformer();
            layer.add(transformer);

            let isSelected = false;

               group.on('click', function () {
               isSelected = !isSelected;
               ellipse.stroke(isSelected ? 'blue' : 'black');

               if (isSelected) {
                   // Voeg de transformer toe aan de ellipse
                   transformer.attachTo(ellipse);
               } else {
                   // Verwijder de transformer van de ellipse
                   transformer.detach();
               }
               // update de layer.
               layer.draw();
           });
       }
       
      
        //deze functie zorgt ervoor dat je meerdere ellipses tegelijk kan verwijderen
        function deleteSelectedEllipses() {
            const selectedGroups = layer.getChildren(node => {
                if (node instanceof Konva.Group) {
            const ellipse = node.getChildren(c => c instanceof Konva.Ellipse)[0];
                return ellipse && ellipse.stroke() === 'blue';
            }
                return false;
            });
        // Loop door alle geselecteerde groepen heen
        selectedGroups.forEach(group => {
        //Deselcteer de ellipse
        const ellipse = group.getChildren(c => c instanceof Konva.Ellipse)[0];
        ellipse.stroke('black');

        // Verwijder de transformer van de ellipse
        const transformers = layer.find(node => node instanceof Konva.Transformer);
            transformers.forEach(transformer => {
                if (transformer.node() === ellipse) {                 
                    transformer.detach();
                }
            });

            // verwijder de ellipse
            group.destroy();
            });

            layer.draw();
        }

        //deze eventlistener luistert naar een click event en voert de functie createEllipse uit. colors is een array die de kleuren bevat en wordt verwezen naar de functie createEllipse.
        document.querySelector('.createEllipse').addEventListener('click', function () {
            const text = document.getElementById('ellipseText').value;
            const backgroundColor = document.getElementById('EllipseBackgroundColor').value;
            const textColor = document.getElementById('EllipseTextColor').value;
            const x = stage.width() / 2;
            const y = stage.height() / 2;
            const radiusX = 100;
            const radiusY = 50;

            createEllipse(text, textColor, backgroundColor, x, y, radiusX, radiusY);
        });

        document.querySelector('.delete').addEventListener('click', function () {
            deleteSelectedEllipses();
        });

document.getElementById('import').onclick = function() {
    var files = document.getElementById('selectFiles').files;
    var reader = new FileReader();

    if (files.length <= 0) {
        return false;
    }

    var fr = new FileReader();

    fr.onload = function(e) {
        console.log(e);
        var json = JSON.parse(e.target.result);
        console.log(json);

        // TODO make json parse function
        //createCircle(result[0].text, result[0].textFill, result[0].shapeFill, result[0].x, result[0].y);
        //createEllipse(result[1].text, result[1].textFill, result[1].shapeFill, result[1].x, result[1].y, result[1].radiusX, result[1].radiusY);

        json.forEach((item) => {
            console.log(item)
            switch (item.type) {
                case 'shapeFill':
                break;
                case 'textFill':
                break;
                case 'text':
                break;
                case 'x':
                break;
                case 'y':
                break;
                case 'radiusX':
                break;
                case 'radiusY':
                break;
                case 'circle':
                    console.log('item is circle');
                break;
                case 'ellipse':
                    console.log('item is ellipse');
                break;
                default:
                    console.log('unknown type');	
                break;
            }
        });
    }

    fr.readAsText(files.item(0));
};

const exportButton = document.getElementById('exportButton');

exportButton.addEventListener('click', function () {
    const data = layer.getChildren((node) => {
        return node.getClassName() === 'Group';
    }).map(child => {
        const shape = child.getChildren((node) => {
            return (
                node.getClassName() === 'Circle' ||
                node.getClassName() === 'Ellipse'
            );
        })[0];

        const textNode = child.getChildren((node) => {
            return node.getClassName() === 'Text';
        })[0];

        return {
            x: child.getAttr('x'), // positie
            y: child.getAttr('y'), // positie
            shapeFill: shape.getAttr('fill'),   // vorm kleur
            text: textNode.getAttr('text'), // tekst
            textFill: textNode.getAttr('fill'),  // tekst kleur
            radiusX: shape.getAttr('radiusX'), // radius x
            radiusY: shape.getAttr('radiusY'), // radius y
            type: shape.attrs.type,
        };
    });

    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], {type: 'application/json'});
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = 'data.json';
    a.click();

    URL.revokeObjectURL(url);
});
    </script>
</body>

</html>